# Ansible
Ansible

**Инфраструктура как код (англ. Infrastructure-as-Code; Iac)** — это подход к управлению и описанию инфраструктуры через конфигурационные файлы, а не через ручное редактирование конфигураций на серверах. Процесс настройки инфраструктуры аналогичен процессу программирования ПО. Границы между написанием приложений и созданием сред для этих приложений стираются.

**Категории инструментов IAC**
- Специализированные - скрипты Скрипты, которые пошагово выполняют ранее ручные действия - Bash, PowerShell и т. д.
- Средства управления конфигурацией - Предназначены для установки и администрирования ПО на существующих серверах - Chef, Ansible, SaltStack
- Средства шаблонизации серверов - На базе образа создают виртуальные машины или контейнеры - Packer, Vagrant, Docker
- Средства оркестрации - Программные средства, позволяющие управлять жизненным циклом объектов - Kubernetes, Google Kubernetes Engine
- Средства инициализации ресурсов - Создают (инициализируют) ресурсы, например, сервера - Terraform, CloudFormation

**Плюсы IAC**
- Нет необходимости в ручной настройке
- Скорость — настройка («поднятие») инфраструктуры занимает заметно меньше времени
- Воспроизводимость — поднимаемая инфраструктура всегда идентична
   Масштабируемость — один инженер может с помощью одного и того же кода настраивать и управлять огромным количеством машин

**Системы управления конфигурациями** — программы и комплексы, позволяющие централизованно управлять конфигурацией множества разнообразных разрозненных ОС и прикладного ПО, работающего в них. При работе с системами управления конфигурациями говорят об автоматизации инфраструктуры или об оркестрации серверов

**Преимущества Configuration management systems:**
- использовать систему контроля версий для отслеживания любых изменений инфраструктуры
- повторно использовать скрипты конфигурирования для нескольких серверных сред, например, для разработки, тестирования и производства
- предоставлять сотрудникам общий доступ к скриптам конфигурирования для упрощения сотрудничества в стандартизированной среде разработки
- упрощать процесс дублирования серверов для ускорения восстановления при сбое системы

**Ведущие инструменты для управления конфигурацией**
- Chef - DSL - Ruby - Клиент-сервер
- Puppet - DSL(JSON) - Ruby - Клиент-сервер 
- SaltStack - YAML - Python - Клиент-сервер, безагентный  
- Ansible - YAML - Python - Безагентный

**Ansible** — система управления конфигурациями.
- Позволяет централизованно управлять ПО, ОС и их настройками на Linux, Mac, Windows
- Написан на Python, открытый исходный код
- Разработчик — Red Hat

**Особенности Ansible**
- **Безагентный** — для работы, настройки с управляемым узлом нет необходимости ставить на управляемый узел агента. Необходимых требований только два: работающий ssh-сервер, python версии 2.6 и выше
- **Идемпотентность** — независимо от того, сколько раз вы будете запускать playbook, результат (конфигурация управляемого узла) всегда должен приводить к одному и тому же состоянию
- **Push-model** — изменения конфигураций «заталкиваются» на управляемые узлы. Это может быть минусом

**Основные термины Ansible**
- **Узел управления** — устройство с установленным и настроенным Ansible. Может быть ваш ноутбук или специальный узел в сети (подсети), выделенный для задач управления
- **Управляемые узлы** — узлы, конфигурация которых выполняется
- **Файлы инвентаризации (inventory)** — файл или файлы, в которых перечислены управляемые узлы: *.ini, *.yaml или динамический
- **Модули (modules)** отвечают за действия, которые выполняет Ansible, другими словами, инструментарий Ansible
- **Задачи (tasks)** — отдельный элемент работы, которую нужно выполнить. Могут выполняться самостоятельно или в составе плейбука
- **Плейбук (playbook)** состоит из списка задач или других директив, указывающих на то, какие действия и где будут производиться
- **Обработчики (handlers)** — элемент, который служит для экономии кода и способен перезапускать службу при его вызове
- **Роли (roles)** — набор плейбуков и других файлов, которые предназначены для выполнения какой-либо конечной задачи. Также упрощают, сокращают код и делают его переносимым

Устанавливаем Ansible:
```
yum install ansible/apt install ansible
```
Правим при необходимости конфигурационный файл Ansible:
```
vim /etc/ansible/ansible.cfg
```
Правим файл inventory по умолчанию или создаём свой:
```
vim /etc/ansible/hosts
```
Смотрим версию и другие переменные запуска Ansible:
```
ansible --version
```
**Inventory**

**Инвентарный файл** — это файл с описанием устройств, к которым будет подключаться и управлять Ansible. Может быть в формате INI или YAML, или быть динамически конфигурируемым какой- либо вычислительной системой. Две группы по умолчанию: all и ungrouped
```
ansible all -m ping --list-hosts — вывести список хостов
ansible-playbook --list-hosts — вывести список хостов для playbook
```
**Ansible.cfg** — это основной конфигурационный файл. Может храниться:
- ANSIBLE_CONFIG — переменная окружения
- ansible.cfg — в текущем каталоге
- ~/.ansible.cfg — в домашнем каталоге пользователя
- /etc/ansible/ansible.cfg — можно брать за образец для внесения правок
```
ansible --version — покажет, какой конфигурационный файл будет использоваться
```
В конфигурационном файле можно задавать множество параметров, например:
```
[defaults]
inventory = inventory.ini # расположение файла inventory
remote_user = ansible # пользователь, которым подключаемся по ssh
gathering = explicit # отключает сбор фактов
forks = 5 # количество хостов, на которых текущая задача выполняется одновременно
[privilege_escalation]
become = True # требуется повышение прав - становимся root
become_user = root # пользователь, под которым будут выполняться задачи
become_method = sudo # способ повышения прав
become_ask_pass = true # спросит пароль при become_method = su - если он понадобится
```
**Параметры** - Большинство настроек также может задаваться или переопределять во время выполнения команд через параметры
```
ansible -i hosts.ini all -m ping — вручную указывает файл инвентори
ansible all -m ping -e "ansible_user=vagrant
ansible_ssh_pass=vagrant" — вручную задаёт удалённого пользователя и пароль
ansible all -u vagrant -m ping — вручную задаёт удалённого пользователя
ansible web* -m ping — задаёт список хостов к выполнению через регулярные выражения
```
**Ansible modules** 

**Модули** — это небольшая программа, входящая в поставку Ansible, принимающая на вход значения и выполняющая работу на целевых хостах. Фактически вся работа происходит с использованием модулей. Можно самостоятельно писать модули и расширять возможности Ansible
```
ansible-doc -l
ansible-doc shell
ansible all (все сервера) -i (путь до инвентори - не нужно если указан в cfg) ./hosts -m (имя модуля) ping
```
**Ansible ad-hoc**

**Ad-hoc команды** — это самый быстрый способ начать использовать Ansible. Для запуска Ansible в режиме ad-hoc не нужно писать плейбуки, достаточно помнить минимальный синтаксис
```
ansible all -m ping
ansible all -m command -a 'cat /etc/hosts'
```
**Часто используемые модули**

- ping - Позволяет проверить доступность хостов для работы через Ansible
- service - Позволяет управлять работой служб (демонов) на хостах
- command - Позволяет запустить команду без использования окружения
- copy - Позволяет копировать файлы
- lineinfile - Позволяет заменять или добавлять строки в текстовых файлах
- debug - Позволяет выводить отладочные сообщения
- git - Позволяет работать с git-репозиториями

```
ssh-copy-id user@server - копируем ssh ключ для соединения без пароля
ansible-doc -l - доступные модули
ansible-doc shell - инструкция по модулю shell
ansible all -m shell -a 'hostname' - выполнение команды hostname на серверах
ansible webservers -m shell -b (become - повышение до root или через cfg) -a "yum install mc"
ansible-doc yum - описание модуля yum
ansible webservers -m yum -b -a 'name=mc state=present' - установка последней версии и если установлено то ничего не делать
ansible webservers -m yum -b -a 'name=mc state=absent' - удаление
ansible webservers -m yum -b -a 'name=mc state=absent' -vvv (-v - verbose от v до vvv - более подробный вывод)
```
